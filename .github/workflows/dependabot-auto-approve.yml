# Dependabot automation workflow
# Auto-merge safe updates and route risky updates to manual review.

name: Dependabot Auto-approve

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: dependabot-auto-merge-${{ github.event.pull_request.number || github.event.check_suite.id || github.run_id }}
  cancel-in-progress: true

jobs:
  auto-approve:
    if: github.event_name == 'pull_request_target' && github.event.pull_request.draft == false && contains(github.event.pull_request.user.login, 'dependabot')
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        continue-on-error: true
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: '${{ secrets.GITHUB_TOKEN }}'

      - name: Classify update risk
        id: classify
        env:
          METADATA_OK: ${{ steps.metadata.outcome == 'success' }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          DEPENDENCY_NAMES: ${{ steps.metadata.outputs.dependency-names }}
          UPDATE_TYPE: ${{ steps.metadata.outputs.update-type }}
          DEPENDENCY_TYPE: ${{ steps.metadata.outputs.dependency-type }}
        run: |
          set -euo pipefail

          dependency_names="$DEPENDENCY_NAMES"
          update_type="$UPDATE_TYPE"
          dependency_type="$DEPENDENCY_TYPE"

          safe_to_automerge="false"
          reason="Manual review required."

          # Best-practice defaults:
          # 1) Auto-merge patch and minor updates.
          # 2) Keep major updates for manual review.
          # If metadata is unavailable, stay in manual-review mode.
          if [[ "$METADATA_OK" != "true" ]]; then
            # Fallback: infer dependency name + semver delta from standard Dependabot title.
            # Example: "bump pkg from 1.2.3 to 1.3.0"
            if [[ -z "$dependency_names" ]]; then
              dependency_names="$(echo "$PR_TITLE" | sed -nE 's/^.*bump ([^ ]+) from .*/\1/p')"
            fi

            if [[ "$PR_TITLE" =~ from[[:space:]]v?([0-9]+)\.([0-9]+)\.([0-9]+)[^[:digit:]]+to[[:space:]]v?([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
              from_major="${BASH_REMATCH[1]}"
              from_minor="${BASH_REMATCH[2]}"
              from_patch="${BASH_REMATCH[3]}"
              to_major="${BASH_REMATCH[4]}"
              to_minor="${BASH_REMATCH[5]}"
              to_patch="${BASH_REMATCH[6]}"

              if (( to_major > from_major )); then
                update_type="version-update:semver-major"
              elif (( to_major == from_major && to_minor > from_minor )); then
                update_type="version-update:semver-minor"
              elif (( to_major == from_major && to_minor == from_minor && to_patch > from_patch )); then
                update_type="version-update:semver-patch"
              fi
            fi

            if [[ "$update_type" == "version-update:semver-patch" || "$update_type" == "version-update:semver-minor" ]]; then
              safe_to_automerge="true"
              reason="Patch/minor update (inferred from PR title)."
            else
              reason="Dependabot metadata unavailable; manual review required."
            fi
          elif [[ "$update_type" == "version-update:semver-patch" || "$update_type" == "version-update:semver-minor" ]]; then
            safe_to_automerge="true"
            reason="Patch/minor update."
          fi

          echo "dependency_names=$dependency_names" >> "$GITHUB_OUTPUT"
          echo "safe_to_automerge=$safe_to_automerge" >> "$GITHUB_OUTPUT"
          echo "reason=$reason" >> "$GITHUB_OUTPUT"
          echo "update_type=$update_type" >> "$GITHUB_OUTPUT"
          echo "dependency_type=$dependency_type" >> "$GITHUB_OUTPUT"

      - name: Label safe updates
        if: steps.classify.outputs.safe_to_automerge == 'true'
        run: |
          gh pr edit "$PR_URL" --add-label "dependencies,dependabot,auto-merge-candidate"
          gh pr edit "$PR_URL" --remove-label "needs-review" || true
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Label manual-review updates
        if: steps.classify.outputs.safe_to_automerge != 'true'
        run: |
          gh pr edit "$PR_URL" --add-label "dependencies,dependabot,needs-review"
          gh pr edit "$PR_URL" --remove-label "auto-merge-candidate" || true
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Label breaking-change updates
        if: steps.classify.outputs.update_type == 'version-update:semver-major'
        run: |
          gh pr edit "$PR_URL" --add-label "major-update,breaking-change"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment safe updates
        if: steps.classify.outputs.safe_to_automerge == 'true'
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          DEPENDENCY_NAMES: ${{ steps.classify.outputs.dependency_names }}
          UPDATE_TYPE: ${{ steps.classify.outputs.update_type }}
          DEPENDENCY_TYPE: ${{ steps.classify.outputs.dependency_type }}
          REASON: ${{ steps.classify.outputs.reason }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          body=$(cat <<EOF
          âœ… Auto-merge enabled

          Dependency: $DEPENDENCY_NAMES
          Update Type: $UPDATE_TYPE
          Dependency Type: $DEPENDENCY_TYPE
          Reason: $REASON

          This PR will be merged automatically after required checks pass.
          EOF
          )
          gh pr comment "$PR_URL" --edit-last --create-if-none --body "$body"

      - name: Comment manual-review updates
        if: steps.classify.outputs.safe_to_automerge != 'true'
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          DEPENDENCY_NAMES: ${{ steps.classify.outputs.dependency_names }}
          UPDATE_TYPE: ${{ steps.classify.outputs.update_type }}
          DEPENDENCY_TYPE: ${{ steps.classify.outputs.dependency_type }}
          REASON: ${{ steps.classify.outputs.reason }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          body=$(cat <<EOF
          ðŸ” Manual review required

          Dependency: $DEPENDENCY_NAMES
          Update Type: $UPDATE_TYPE
          Dependency Type: $DEPENDENCY_TYPE
          Reason: $REASON

          Please review changelog and compatibility before merging.
          EOF
          )
          gh pr comment "$PR_URL" --edit-last --create-if-none --body "$body"

      - name: Approve safe updates
        if: steps.classify.outputs.safe_to_automerge == 'true'
        continue-on-error: true
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          REASON: ${{ steps.classify.outputs.reason }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh pr review "$PR_URL" --approve --body "Approved by automation: $REASON"

      - name: Enable auto-merge for safe updates
        if: steps.classify.outputs.safe_to_automerge == 'true'
        continue-on-error: true
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh pr merge "$PR_URL" --auto --squash --delete-branch

      - name: Ensure general Dependabot label
        run: |
          gh pr edit "$PR_URL" --add-label "dependabot"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  merge-safe-updates:
    if: github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Resolve linked pull request
        id: pr
        run: |
          set -euo pipefail
          pr_number="$(jq -r '.check_suite.pull_requests[0].number // empty' "$GITHUB_EVENT_PATH")"
          echo "number=$pr_number" >> "$GITHUB_OUTPUT"

      - name: Exit if no linked pull request
        if: steps.pr.outputs.number == ''
        run: |
          echo "No pull request linked to this check suite."

      - name: Check merge eligibility
        if: steps.pr.outputs.number != ''
        id: gate
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          set -euo pipefail

          pr_json="$(gh pr view "$PR_NUMBER" --json author,isDraft,labels,mergeable,mergeStateStatus,statusCheckRollup,url,title,body)"

          is_dependabot="$(echo "$pr_json" | jq -r '.author.login | test("dependabot")')"
          is_draft="$(echo "$pr_json" | jq -r '.isDraft')"
          has_candidate_label="$(echo "$pr_json" | jq -r '[.labels[].name] | index("auto-merge-candidate") != null')"
          has_needs_review_label="$(echo "$pr_json" | jq -r '[.labels[].name] | index("needs-review") != null')"
          has_breaking_label="$(echo "$pr_json" | jq -r '[.labels[].name] | index("breaking-change") != null')"
          has_breaking_text="$(echo "$pr_json" | jq -r '((.title // "") + "\n" + (.body // "")) | ascii_downcase | test("breaking[ -]change|breaking[ -]changes|incompatible")')"
          is_mergeable="$(echo "$pr_json" | jq -r '.mergeable == "MERGEABLE"')"
          merge_state_clean="$(echo "$pr_json" | jq -r '.mergeStateStatus == "CLEAN" or .mergeStateStatus == "HAS_HOOKS"')"
          has_checks="$(echo "$pr_json" | jq -r '[.statusCheckRollup[]?] | length > 0')"
          checks_green="$(echo "$pr_json" | jq -r '
            [.statusCheckRollup[]? |
              if .status == "COMPLETED"
              then (.conclusion == "SUCCESS" or .conclusion == "NEUTRAL" or .conclusion == "SKIPPED")
              else false
              end
            ] | all
          ')"

          should_merge="false"
          if [[ "$is_dependabot" == "true" && "$is_draft" == "false" && "$has_candidate_label" == "true" && "$has_needs_review_label" == "false" && "$has_breaking_label" == "false" && "$has_breaking_text" == "false" && "$is_mergeable" == "true" && "$merge_state_clean" == "true" && "$has_checks" == "true" && "$checks_green" == "true" ]]; then
            should_merge="true"
          fi

          echo "should_merge=$should_merge" >> "$GITHUB_OUTPUT"
          echo "pr_url=$(echo "$pr_json" | jq -r '.url')" >> "$GITHUB_OUTPUT"

      - name: Merge safe dependency update
        if: steps.gate.outputs.should_merge == 'true'
        env:
          PR_URL: ${{ steps.gate.outputs.pr_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "$PR_URL" || ! "$PR_URL" =~ ^https://github\.com/[^/]+/[^/]+/pull/[0-9]+$ ]]; then
            echo "Invalid pull request URL: $PR_URL"
            exit 1
          fi
          gh pr merge "$PR_URL" --squash --delete-branch
