name: Cache Management

on:
  schedule:
    # Clean up old caches weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      action:
        description: 'Cache management action'
        required: true
        default: 'cleanup'
        type: choice
        options:
          - cleanup
          - warm-cache
          - analyze
          - purge-all

env:
  NODE_VERSION: '24.x'

jobs:
  # Analyze cache usage and efficiency
  cache-analysis:
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'analyze' || github.event.inputs.action == 'cleanup'
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js and PNPM
        uses: ./.github/actions/setup-node-pnpm

      - name: Analyze cache patterns
        run: |
          echo "## ðŸ“Š Cache Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Analysis Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Analyze PNPM store size
          store_path=$(pnpm store path)
          if [ -d "$store_path" ]; then
            store_size=$(du -sh "$store_path" | cut -f1)
            echo "### PNPM Store:" >> $GITHUB_STEP_SUMMARY
            echo "- Location: \`$store_path\`" >> $GITHUB_STEP_SUMMARY
            echo "- Size: $store_size" >> $GITHUB_STEP_SUMMARY
          fi

          # Analyze Turborepo cache
          if [ -d ".turbo" ]; then
            turbo_size=$(du -sh .turbo | cut -f1)
            cache_entries=$(find .turbo/cache -name "*.tar.zst" 2>/dev/null | wc -l)
            echo "### Turborepo Cache:" >> $GITHUB_STEP_SUMMARY
            echo "- Size: $turbo_size" >> $GITHUB_STEP_SUMMARY
            echo "- Cache entries: $cache_entries" >> $GITHUB_STEP_SUMMARY
          fi

          # Analyze node_modules
          total_nm_size=0
          for nm in node_modules apps/*/node_modules packages/*/node_modules; do
            if [ -d "$nm" ]; then
              size=$(du -sm "$nm" | cut -f1)
              total_nm_size=$((total_nm_size + size))
              echo "- $nm: ${size}MB" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "### Node Modules:" >> $GITHUB_STEP_SUMMARY
          echo "- Total size: ${total_nm_size}MB" >> $GITHUB_STEP_SUMMARY

  # Warm up caches for faster CI runs
  warm-cache:
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'warm-cache'
    strategy:
      matrix:
        cache-type: [dependencies, build, test]
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js and PNPM
        uses: ./.github/actions/setup-node-pnpm

      - name: Warm ${{ matrix.cache-type }} cache
        run: |
          case "${{ matrix.cache-type }}" in
            "dependencies")
              echo "Warming dependency cache..."
              pnpm install --frozen-lockfile --prefer-offline
              ;;
            "build")
              echo "Warming build cache..."
              pnpm install --frozen-lockfile --prefer-offline
              pnpm turbo run build --force
              ;;
            "test")
              echo "Warming test cache..."
              pnpm install --frozen-lockfile --prefer-offline
              pnpm turbo run build
              pnpm turbo run test --run
              ;;
          esac

      - name: Cache warming summary
        run: |
          echo "âœ… ${{ matrix.cache-type }} cache warmed successfully" >> $GITHUB_STEP_SUMMARY

  # Clean up old and unused caches
  cache-cleanup:
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'cleanup' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js and PNPM
        uses: ./.github/actions/setup-node-pnpm

      - name: Clean PNPM store
        run: |
          echo "Cleaning PNPM store..."
          pnpm store prune

      - name: Clean Turborepo cache
        run: |
          echo "Cleaning Turborepo cache..."
          # Keep only last 7 days of cache
          find .turbo/cache -name "*.tar.zst" -mtime +7 -delete 2>/dev/null || true

      - name: Clean node_modules
        run: |
          echo "Cleaning node_modules..."
          # Remove node_modules to force fresh install
          rm -rf node_modules apps/*/node_modules packages/*/node_modules

      - name: Reinstall dependencies
        run: |
          echo "Reinstalling dependencies..."
          pnpm install --frozen-lockfile --prefer-offline

      - name: Cleanup summary
        run: |
          echo "## ðŸ§¹ Cache Cleanup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cleanup Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions Performed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PNPM store pruned" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Old Turborepo cache entries removed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Node modules cleaned and reinstalled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Benefits:" >> $GITHUB_STEP_SUMMARY
          echo "- Reduced cache storage usage" >> $GITHUB_STEP_SUMMARY
          echo "- Faster CI runs with fresh caches" >> $GITHUB_STEP_SUMMARY
          echo "- Eliminated stale dependencies" >> $GITHUB_STEP_SUMMARY

  # Purge all caches (emergency action)
  purge-all-caches:
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'purge-all'
    steps:
      - uses: actions/checkout@v6

      - name: Purge all caches
        run: |
          echo "âš ï¸ PURGING ALL CACHES - This will slow down next CI runs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Remove all local caches
          rm -rf node_modules apps/*/node_modules packages/*/node_modules
          rm -rf .turbo
          rm -rf ~/.pnpm-store

          echo "### Purged:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… All node_modules directories" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Turborepo cache" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PNPM store" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Next CI runs will be slower as caches rebuild" >> $GITHUB_STEP_SUMMARY

  # Cache optimization recommendations
  cache-optimization:
    runs-on: ubuntu-latest
    needs: [cache-analysis]
    if: always() && (github.event.inputs.action == 'analyze' || github.event_name == 'schedule')
    steps:
      - name: Generate optimization recommendations
        run: |
          echo "## ðŸ’¡ Cache Optimization Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Current Strategy:" >> $GITHUB_STEP_SUMMARY
          echo "- **PNPM Store:** Cached by lockfile hash with 7-day retention" >> $GITHUB_STEP_SUMMARY
          echo "- **Turborepo:** Cached by task inputs with branch-specific scopes" >> $GITHUB_STEP_SUMMARY
          echo "- **Node Modules:** Cached by lockfile hash for faster installs" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Artifacts:** Cached by source hash for incremental builds" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Optimization Tips:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Dependency Changes:** Update lockfile carefully to preserve cache hits" >> $GITHUB_STEP_SUMMARY
          echo "2. **Build Inputs:** Keep task inputs minimal to improve cache efficiency" >> $GITHUB_STEP_SUMMARY
          echo "3. **Cache Keys:** Use specific keys for better cache granularity" >> $GITHUB_STEP_SUMMARY
          echo "4. **Cleanup Schedule:** Run weekly cleanup to prevent cache bloat" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Monitoring:" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor CI run times for cache effectiveness" >> $GITHUB_STEP_SUMMARY
          echo "- Track cache hit rates in Turborepo summaries" >> $GITHUB_STEP_SUMMARY
          echo "- Review storage usage monthly" >> $GITHUB_STEP_SUMMARY
