version: '3.8'

services:
  app:
    container_name: chatgpt-web
    image: chenzhaoyu94/chatgpt-web # Always use latest, just pull the tag image again when updating
    ports:
      - 3002:3002
    environment:
      # ===========================================
      # Provider Configuration (Required)
      # ===========================================
      
      # AI Provider Selection: 'openai' or 'azure'
      AI_PROVIDER: ${AI_PROVIDER:-openai}
      
      # ===========================================
      # OpenAI Configuration
      # ===========================================
      
      # OpenAI API Key (required when AI_PROVIDER=openai)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      
      # OpenAI API Base URL (optional)
      OPENAI_API_BASE_URL: ${OPENAI_API_BASE_URL:-https://api.openai.com}
      
      # OpenAI API Model (optional)
      DEFAULT_MODEL: ${DEFAULT_MODEL:-gpt-4o}
      
      # ===========================================
      # Azure OpenAI Configuration
      # ===========================================
      
      # Azure OpenAI API Key (required when AI_PROVIDER=azure)
      AZURE_OPENAI_API_KEY: ${AZURE_OPENAI_API_KEY:-}
      
      # Azure OpenAI Endpoint (required when AI_PROVIDER=azure)
      AZURE_OPENAI_ENDPOINT: ${AZURE_OPENAI_ENDPOINT:-}
      
      # Azure OpenAI Deployment Name (required when AI_PROVIDER=azure)
      AZURE_OPENAI_DEPLOYMENT: ${AZURE_OPENAI_DEPLOYMENT:-}
      
      # Azure OpenAI API Version (optional)
      AZURE_OPENAI_API_VERSION: ${AZURE_OPENAI_API_VERSION:-2024-02-15-preview}
      
      # Azure OpenAI v1 Responses API (optional)
      AZURE_OPENAI_USE_RESPONSES_API: ${AZURE_OPENAI_USE_RESPONSES_API:-true}
      
      # ===========================================
      # Security Configuration
      # ===========================================
      
      # Authentication Secret Key (optional)
      AUTH_SECRET_KEY: ${AUTH_SECRET_KEY:-}
      
      # Session Secret Key (required in production)
      SESSION_SECRET: ${SESSION_SECRET:-}
      
      # Rate Limiting - Requests per hour (optional, default: 100)
      MAX_REQUEST_PER_HOUR: ${MAX_REQUEST_PER_HOUR:-100}
      
      # Rate Limiting Window in milliseconds (optional)
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-3600000}
      
      # Rate Limiting Max Requests per window (optional)
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS:-100}
      
      # ===========================================
      # Performance Configuration
      # ===========================================
      
      # Request timeout in milliseconds (optional)
      TIMEOUT_MS: ${TIMEOUT_MS:-60000}
      
      # Retry configuration (optional)
      RETRY_MAX_ATTEMPTS: ${RETRY_MAX_ATTEMPTS:-3}
      RETRY_BASE_DELAY: ${RETRY_BASE_DELAY:-1000}
      
      # ===========================================
      # Reasoning Models Configuration
      # ===========================================
      
      # Enable reasoning models (optional)
      ENABLE_REASONING_MODELS: ${ENABLE_REASONING_MODELS:-true}
      
      # Reasoning model timeout (optional)
      REASONING_MODEL_TIMEOUT_MS: ${REASONING_MODEL_TIMEOUT_MS:-120000}
      
      # ===========================================
      # Development Configuration
      # ===========================================
      
      # Environment mode
      NODE_ENV: ${NODE_ENV:-production}
      
      # Logging level
      LOG_LEVEL: ${LOG_LEVEL:-info}
      
      # Enable request logging (optional)
      ENABLE_REQUEST_LOGGING: ${ENABLE_REQUEST_LOGGING:-false}
      
      # Enable security headers (optional)
      ENABLE_SECURITY_HEADERS: ${ENABLE_SECURITY_HEADERS:-true}
      
      # ===========================================
      # CORS and HTTPS Configuration
      # ===========================================
      
      # CORS allowed origins (optional, comma-separated)
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-}
      
      # CORS credentials (optional)
      CORS_CREDENTIALS: ${CORS_CREDENTIALS:-true}
      
      # HTTPS Configuration (production)
      HTTPS: ${HTTPS:-}
      SSL_CERT_PATH: ${SSL_CERT_PATH:-}
      SSL_KEY_PATH: ${SSL_KEY_PATH:-}
      
      # ===========================================
      # Proxy Configuration (Optional)
      # ===========================================
      
      # SOCKS proxy configuration
      SOCKS_PROXY_HOST: ${SOCKS_PROXY_HOST:-}
      SOCKS_PROXY_PORT: ${SOCKS_PROXY_PORT:-}
      SOCKS_PROXY_USERNAME: ${SOCKS_PROXY_USERNAME:-}
      SOCKS_PROXY_PASSWORD: ${SOCKS_PROXY_PASSWORD:-}
      
      # HTTP/HTTPS proxy
      HTTPS_PROXY: ${HTTPS_PROXY:-}
      ALL_PROXY: ${ALL_PROXY:-}
      
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3002/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - chatgpt-web

  nginx:
    container_name: nginx
    image: nginx:alpine
    ports:
      - '80:80'
    expose:
      - '80'
    volumes:
      - ./nginx/html:/usr/share/nginx/html
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - app
    restart: unless-stopped
    networks:
      - chatgpt-web

networks:
  chatgpt-web:
    driver: bridge
