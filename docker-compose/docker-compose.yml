version: '3.8'

services:
  app:
    container_name: chatgpt-web
    build:
      context: ..
      dockerfile: Dockerfile
    image: chatgpt-web:local
    ports:
      - 3002:3002
    environment:
      # ===========================================
      # Provider Configuration
      # ===========================================
      AI_PROVIDER: ${AI_PROVIDER:-openai}
      DEFAULT_MODEL: ${DEFAULT_MODEL:-gpt-5.1}
      OPENAI_API_MODEL: ${OPENAI_API_MODEL:-gpt-5.1}

      # ===========================================
      # OpenAI Configuration (AI_PROVIDER=openai)
      # ===========================================
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_API_BASE_URL: ${OPENAI_API_BASE_URL:-https://api.openai.com}
      SKIP_API_DOMAIN_CHECK: ${SKIP_API_DOMAIN_CHECK:-false}
      OPENAI_API_DISABLE_DEBUG: ${OPENAI_API_DISABLE_DEBUG:-}
      OPENAI_ORGANIZATION: ${OPENAI_ORGANIZATION:-}

      # ===========================================
      # Azure OpenAI Configuration (AI_PROVIDER=azure)
      # ===========================================
      AZURE_OPENAI_API_KEY: ${AZURE_OPENAI_API_KEY:-}
      AZURE_OPENAI_ENDPOINT: ${AZURE_OPENAI_ENDPOINT:-}
      AZURE_OPENAI_DEPLOYMENT: ${AZURE_OPENAI_DEPLOYMENT:-}
      AZURE_OPENAI_API_VERSION: ${AZURE_OPENAI_API_VERSION:-2024-02-15-preview}
      AZURE_OPENAI_USE_RESPONSES_API: ${AZURE_OPENAI_USE_RESPONSES_API:-true}

      # ===========================================
      # Security and Access Control
      # ===========================================
      AUTH_SECRET_KEY: ${AUTH_SECRET_KEY:-}
      SESSION_SECRET: ${SESSION_SECRET:-}
      MAX_REQUEST_PER_HOUR: ${MAX_REQUEST_PER_HOUR:-100}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-}
      CORS_ORIGIN: ${CORS_ORIGIN:-}
      CORS_CREDENTIALS: ${CORS_CREDENTIALS:-true}
      HTTPS: ${HTTPS:-}

      # Optional Redis session store
      REDIS_URL: ${REDIS_URL:-}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}

      # Provider-config compatibility flags
      ENABLE_RATE_LIMIT: ${ENABLE_RATE_LIMIT:-true}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-3600000}
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS:-100}
      ENABLE_CSP: ${ENABLE_CSP:-true}
      ENABLE_HSTS: ${ENABLE_HSTS:-true}
      API_KEY_HEADER: ${API_KEY_HEADER:-authorization}
      ENABLE_REASONING_MODELS: ${ENABLE_REASONING_MODELS:-true}
      ENABLE_REASONING: ${ENABLE_REASONING:-true}

      # ===========================================
      # Server and Logging
      # ===========================================
      NODE_ENV: ${NODE_ENV:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      PORT: ${PORT:-3002}
      HOST: ${HOST:-0.0.0.0}

      # Development flags
      DEBUG: ${DEBUG:-}
      HOT_RELOAD: ${HOT_RELOAD:-}

      # ===========================================
      # Network / Proxy
      # ===========================================
      TIMEOUT_MS: ${TIMEOUT_MS:-60000}
      SOCKS_PROXY_HOST: ${SOCKS_PROXY_HOST:-}
      SOCKS_PROXY_PORT: ${SOCKS_PROXY_PORT:-}
      SOCKS_PROXY_USERNAME: ${SOCKS_PROXY_USERNAME:-}
      SOCKS_PROXY_PASSWORD: ${SOCKS_PROXY_PASSWORD:-}
      HTTPS_PROXY: ${HTTPS_PROXY:-}
      ALL_PROXY: ${ALL_PROXY:-}

    restart: unless-stopped
    healthcheck:
      test:
        ["CMD", "node", "-e", "require('http').get('http://localhost:3002/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
