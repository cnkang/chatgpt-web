version: '3.8'

services:
  # Development setup with volume mounts for hot reloading
  app-dev:
    container_name: chatgpt-web-dev
    build:
      context: ..
      dockerfile: Dockerfile
    ports:
      - "3002:3002" # API port
      - "1002:1002" # Web dev server port (if running web dev server)
    environment:
      NODE_ENV: development
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      PORT: ${PORT:-3002}
      HOST: ${HOST:-0.0.0.0}

      # Provider configuration
      AI_PROVIDER: ${AI_PROVIDER:-openai}
      DEFAULT_MODEL: ${DEFAULT_MODEL:-gpt-4o}
      OPENAI_API_MODEL: ${OPENAI_API_MODEL:-gpt-4o}

      # OpenAI configuration
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_API_BASE_URL: ${OPENAI_API_BASE_URL:-https://api.openai.com}
      OPENAI_API_DISABLE_DEBUG: ${OPENAI_API_DISABLE_DEBUG:-}
      OPENAI_ORGANIZATION: ${OPENAI_ORGANIZATION:-}

      # Azure OpenAI configuration
      AZURE_OPENAI_API_KEY: ${AZURE_OPENAI_API_KEY:-}
      AZURE_OPENAI_ENDPOINT: ${AZURE_OPENAI_ENDPOINT:-}
      AZURE_OPENAI_DEPLOYMENT: ${AZURE_OPENAI_DEPLOYMENT:-}
      AZURE_OPENAI_API_VERSION: ${AZURE_OPENAI_API_VERSION:-2024-02-15-preview}
      AZURE_OPENAI_USE_RESPONSES_API: ${AZURE_OPENAI_USE_RESPONSES_API:-true}

      # Security / access control
      AUTH_SECRET_KEY: ${AUTH_SECRET_KEY:-dev-secret-key}
      SESSION_SECRET: ${SESSION_SECRET:-dev-session-secret}
      MAX_REQUEST_PER_HOUR: ${MAX_REQUEST_PER_HOUR:-0}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-}
      CORS_ORIGIN: ${CORS_ORIGIN:-}
      CORS_CREDENTIALS: ${CORS_CREDENTIALS:-true}
      HTTPS: ${HTTPS:-}

      # Optional Redis session store
      REDIS_URL: ${REDIS_URL:-}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}

      # Compatibility flags (provider config layer)
      ENABLE_RATE_LIMIT: ${ENABLE_RATE_LIMIT:-true}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-3600000}
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS:-0}
      ENABLE_CSP: ${ENABLE_CSP:-true}
      ENABLE_HSTS: ${ENABLE_HSTS:-true}
      API_KEY_HEADER: ${API_KEY_HEADER:-authorization}
      ENABLE_REASONING_MODELS: ${ENABLE_REASONING_MODELS:-true}
      ENABLE_REASONING: ${ENABLE_REASONING:-true}
      DEBUG: ${DEBUG:-true}
      HOT_RELOAD: ${HOT_RELOAD:-true}

      # Networking
      TIMEOUT_MS: ${TIMEOUT_MS:-60000}
      SOCKS_PROXY_HOST: ${SOCKS_PROXY_HOST:-}
      SOCKS_PROXY_PORT: ${SOCKS_PROXY_PORT:-}
      SOCKS_PROXY_USERNAME: ${SOCKS_PROXY_USERNAME:-}
      SOCKS_PROXY_PASSWORD: ${SOCKS_PROXY_PASSWORD:-}
      HTTPS_PROXY: ${HTTPS_PROXY:-}
      ALL_PROXY: ${ALL_PROXY:-}

    volumes:
      # Mount source code for hot reloading
      - ../apps:/app/apps
      - ../packages:/app/packages
      - ../node_modules:/app/node_modules
      - ../.env:/app/.env:ro
    command: ["sh", "-c", "cd apps/api && pnpm dev"]
    restart: unless-stopped
    networks:
      - chatgpt-dev

  # Redis for session storage (optional)
  redis-dev:
    container_name: redis-dev
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - chatgpt-dev

networks:
  chatgpt-dev:
    driver: bridge

volumes:
  redis_data:
